<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360¬∞ Bilvisning ‚Äì Upload</title>
    <style>
        html, body {
            overscroll-behavior: none;
            touch-action: none;
            background: #f2f2f2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #upload-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #viewer {
            width: 600px;
            height: 400px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: grab;
            background: #fff;
            display: none;
            position: relative;
        }

        #viewer img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* standard p√• web */
            user-select: none;
            pointer-events: none;
            transform-origin: center center;
            transition: transform 0.15s ease-out;
        }

        /* üì± Mobil */
        @media (max-width: 768px) {
            #viewer {
                width: 90vw;
                max-width: 600px;
                aspect-ratio: 3 / 2;
            }

            #viewer img {
                object-fit: contain; /* s√• hele bilen ses p√• mobil */
            }
        }

        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        button {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #1976d2;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background: #0d47a1;
        }

        #control-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

    </style>
</head>
<body>

<div id="upload-container">
    <h2>Upload billeder til 360¬∞ visning</h2>
    <input type="file" id="imageInput" accept="image/*" multiple>
    <p>V√¶lg fx 10‚Äì20 billeder taget rundt om bilen.</p>
</div>

<div id="viewer">
    <img id="car" />
    <canvas id="canvasOverlay"></canvas>
</div>

<div id="control-buttons">
    <button id="startAnimBtn">‚ñ∂Ô∏è Start animation</button>
    <button id="stopAnimBtn" disabled>‚è∏Ô∏è Stop animation</button>
    <button id="toggleMarksBtn">‚úèÔ∏è Markering: Fra</button>
    <button id="saveImageBtn">üíæ Gem billede</button>
</div>

<button id="backBtn">üîô Tilbage til Dashboard</button>

<script>
    // --- Generelle variabler ---
    let images = [];
    let frame = 0;
    let zoom = 1;
    let interval = null;
    let initialDistance = 0;
    let isDragging = false;
    let startX = 0;

    const viewer = document.getElementById("viewer");
    const car = document.getElementById("car");
    const canvas = document.getElementById("canvasOverlay");
    const ctx = canvas.getContext("2d");

    // --- Markeringer (gemmes per billede/frame) ---
    let markingEnabled = false;
    let marks = {}; // fx marks[0] = [ {x,y,radius,color}, ... ]
    let lastTouchTime = 0;

    // --- Hj√¶lpefunktioner ---
    function getTouchPos(e) {
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        return { x: t.clientX - rect.left, y: t.clientY - rect.top };
    }

    function drawCircles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const frameCircles = marks[frame] || [];
        frameCircles.forEach(c => {
            ctx.beginPath();
            ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
            ctx.strokeStyle = c.color;
            ctx.lineWidth = 3;
            ctx.stroke();
        });
    }

    function updateImage() {
        car.src = images[frame];
        drawCircles(); // Tegn markeringer for aktuel frame
    }

    // --- Upload billeder ---
    document.getElementById("imageInput").addEventListener("change", e => {
        const files = Array.from(e.target.files);
        if (!files.length) return alert("V√¶lg mindst √©t billede.");

        files.sort((a, b) => a.name.localeCompare(b.name));
        images = files.map(f => URL.createObjectURL(f));

        frame = 0;
        updateImage();
        viewer.style.display = "block";

        canvas.width = viewer.clientWidth;
        canvas.height = viewer.clientHeight;
        drawCircles();
    });

    // --- Rotation (mus) ---
    viewer.addEventListener("mousedown", e => {
        if (markingEnabled) return; // üö´ ingen rotation ved markering
        isDragging = true;
        startX = e.clientX;
        viewer.style.cursor = "grabbing";
    });

    viewer.addEventListener("mouseup", () => {
        isDragging = false;
        viewer.style.cursor = "grab";
    });

    viewer.addEventListener("mousemove", e => {
        if (markingEnabled) return; // üö´ ingen rotation ved markering
        if (!isDragging || !images.length) return;
        const delta = e.clientX - startX;
        if (Math.abs(delta) > 10) {
            frame += delta > 0 ? -1 : 1;
            if (frame < 0) frame = images.length - 1;
            if (frame >= images.length) frame = 0;
            updateImage();
            startX = e.clientX;
        }
    });

    // --- Zoom ---
    viewer.addEventListener("wheel", e => {
        e.preventDefault();
        zoom += e.deltaY < 0 ? 0.1 : -0.1;
        zoom = Math.min(Math.max(zoom, 1), 3);
        car.style.transform = canvas.style.transform = `scale(${zoom})`;
    });

    viewer.addEventListener("dblclick", () => {
        zoom = 1;
        car.style.transform = canvas.style.transform = "scale(1)";
    });

    // --- Touchrotation + pinchzoom ---
    let lastTouchX = 0;

    viewer.addEventListener("touchstart", e => {
        if (e.touches.length === 1) lastTouchX = e.touches[0].clientX;
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            initialDistance = Math.hypot(dx, dy);
        }
        e.preventDefault();
    });

    viewer.addEventListener("touchmove", e => {
        if (e.touches.length === 1 && !markingEnabled) {
            const touchX = e.touches[0].clientX;
            const delta = touchX - lastTouchX;
            if (Math.abs(delta) > 10 && images.length) {
                frame += delta > 0 ? -1 : 1;
                if (frame < 0) frame = images.length - 1;
                if (frame >= images.length) frame = 0;
                updateImage();
                lastTouchX = touchX;
            }
            e.preventDefault();
        }
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const distance = Math.hypot(dx, dy);
            const scaleChange = distance / initialDistance;
            zoom *= scaleChange;
            zoom = Math.min(Math.max(zoom, 1), 3);
            car.style.transform = canvas.style.transform = `scale(${zoom})`;
            initialDistance = distance;
            e.preventDefault();
        }
    });

    // --- Markeringer med mus p√• web ---
    let isMouseDown = false;
    let selectedCircle = null;

    canvas.addEventListener("mousedown", e => {
        if (!markingEnabled) return;
        const rect = canvas.getBoundingClientRect();
        const pos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        if (!marks[frame]) marks[frame] = [];
        const frameCircles = marks[frame];

        // Find eksisterende cirkel under musen
        selectedCircle = frameCircles.find(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);

        const now = Date.now();
        if (!selectedCircle) {
            // Opret ny cirkel
            frameCircles.push({ x: pos.x, y: pos.y, radius: 30, color: "red" });
            drawCircles();
        } else if (now - lastTouchTime < 400) {
            // Dobbeltklik sletter
            const i = frameCircles.indexOf(selectedCircle);
            frameCircles.splice(i, 1);
            drawCircles();
        }
        lastTouchTime = now;
        isMouseDown = true;
    });

    canvas.addEventListener("mousemove", e => {
        if (!markingEnabled || !isMouseDown || !selectedCircle) return;
        const rect = canvas.getBoundingClientRect();
        const pos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        selectedCircle.x = pos.x;
        selectedCircle.y = pos.y;
        drawCircles();
    });

    canvas.addEventListener("mouseup", () => {
        isMouseDown = false;
        selectedCircle = null;
    });

    // --- Markeringer (touch) ---
    canvas.addEventListener("touchstart", e => {
        if (!markingEnabled) return;
        e.preventDefault();
        const pos = getTouchPos(e);

        if (!marks[frame]) marks[frame] = [];
        const frameCircles = marks[frame];
        let dragIndex = frameCircles.findIndex(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);
        const now = Date.now();

        if (dragIndex === -1) {
            frameCircles.push({ x: pos.x, y: pos.y, radius: 30, color: "red" });
        } else if (now - lastTouchTime < 400) {
            frameCircles.splice(dragIndex, 1); // dobbelttryk = slet
        }
        lastTouchTime = now;
        drawCircles();
    });

    canvas.addEventListener("touchmove", e => {
        if (!markingEnabled) return;
        e.preventDefault();
        const frameCircles = marks[frame];
        if (!frameCircles) return;

        const pos = getTouchPos(e);
        const dragIndex = frameCircles.findIndex(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);
        if (dragIndex !== -1) {
            frameCircles[dragIndex].x = pos.x;
            frameCircles[dragIndex].y = pos.y;
            drawCircles();
        }
    });

    // --- Animation ---
    const startBtn = document.getElementById("startAnimBtn");
    const stopBtn = document.getElementById("stopAnimBtn");

    startBtn.addEventListener("click", () => {
        if (!images.length) return;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        interval = setInterval(() => {
            frame = (frame + 1) % images.length;
            updateImage();
        }, 300); // 300ms = rolig rotation
    });

    stopBtn.addEventListener("click", () => {
        clearInterval(interval);
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });

    // --- Toggle markering ---
    const toggleBtn = document.getElementById("toggleMarksBtn");
    toggleBtn.addEventListener("click", () => {
        markingEnabled = !markingEnabled;
        toggleBtn.textContent = markingEnabled ? "‚úèÔ∏è Markering: Til" : "‚úèÔ∏è Markering: Fra";
    });

    // --- Tilbage ---
    document.getElementById("backBtn").addEventListener("click", () => {
        if (window.AndroidInterface) {
            window.AndroidInterface.goBackToDashboard();
        } else {
            window.location.href = "dashboard.html";
        }
    });

    // Gem billede
    document.getElementById("saveImageBtn").addEventListener("click", async () => {
        if (!images.length) return alert("V√¶lg mindst √©t billede f√∏rst!");

        try {
            const currentImage = images[frame];
            console.log("Gemmer billede:", currentImage);

            // 1Ô∏è‚É£ Hent billedet som blob
            const blob = await fetch(currentImage).then(r => r.blob());

            // 2Ô∏è‚É£ Gem lokalt (download til brugerens computer)
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "bilbillede_" + Date.now() + ".jpg";
            a.click(); // tving download
            URL.revokeObjectURL(url);

            // 3Ô∏è‚É£ Konverter til Base64 for upload til MongoDB
            const base64 = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(",")[1]);
                reader.readAsDataURL(blob);
            });

            // 4Ô∏è‚É£ Send til backend (MongoDB Atlas)
            const payload = {
                filename: "bilbillede_" + Date.now() + ".jpg",
                data: base64,
                marks: marks[frame] || [] // üî• gem kun markeringerne for den aktuelle frame
            };

            const BASE_URL = window.location.hostname === "localhost"
                ? "http://localhost:3000"
                : "https://hovedopgave.onrender.com";

            const response = await fetch(`${BASE_URL}/uploadImage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                alert("‚úÖ Billedet er gemt b√•de lokalt og i MongoDB!");
            } else {
                alert("‚ö†Ô∏è Kun gemt lokalt (fejl ved upload)");
            }
        } catch (err) {
            console.error("Fejl ved gemning:", err);
            alert("Der opstod en fejl under gemning.");
        }
    });
</script>
</body>
</html>