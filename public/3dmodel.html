<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>360¬∞ Bilvisning ‚Äì Upload</title>
    <style>
        html, body {
            overscroll-behavior: none;
            touch-action: none;
            background: #f2f2f2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #upload-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #viewer {
            width: 600px;
            height: 400px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: grab;
            background: #fff;
            display: none;
            position: relative;
        }

        #viewer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            user-select: none;
            pointer-events: none;
            transform-origin: center center;
            transition: transform 0.15s ease-out;
        }

        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        #backBtn {
            margin-top: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #1976d2;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        #backBtn:hover {
            background: #0d47a1;
        }
    </style>
</head>
<body>

<div id="upload-container">
    <h2>Upload billeder til 360¬∞ visning</h2>
    <input type="file" id="imageInput" accept="image/*" multiple>
    <p>V√¶lg fx 10‚Äì20 billeder taget rundt om bilen.</p>
</div>

<div id="viewer">
    <img id="car" />
    <canvas id="canvasOverlay"></canvas>
</div>

<!-- üé¨ Animation kontrol -->
<div id="controls" style="margin-top: 10px; display: flex; gap: 10px;">
    <button id="startBtn">‚ñ∂Ô∏è Start animation</button>
    <button id="stopBtn">‚è∏Ô∏è Stop animation</button>
</div>

<!-- üîô Tilbage -->
<button id="backBtn">Tilbage til Dashboard</button>

<script>
    // --- Generelle variabler ---
    let images = [];
    let frame = 0;
    let isDragging = false;
    let startX = 0;
    let zoom = 1;
    let initialDistance = 0;

    const viewer = document.getElementById("viewer");
    const car = document.getElementById("car");
    const canvas = document.getElementById("canvasOverlay");
    const ctx = canvas.getContext("2d");

    // --- Cirkler og touch kontrol ---
    let circles = [];
    let dragIndex = null;
    let dragStart = null;
    let lastTouchTime = 0;

    // --- Hj√¶lpemetode til touch-koordinater ---
    function getTouchPos(e) {
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = t.clientX - rect.left;
        const y = t.clientY - rect.top;
        return { x, y };
    }

    // --- Tegn alle cirkler ---
    function drawCircles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        circles.forEach(c => {
            ctx.beginPath();
            ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
            ctx.strokeStyle = c.color;
            ctx.lineWidth = 3;
            ctx.stroke();
        });
    }

    // --- Opdater aktuelt billede ---
    function updateImage() {
        car.src = images[frame];
    }

    // --- N√•r brugeren v√¶lger billeder ---
    document.getElementById("imageInput").addEventListener("change", event => {
        const files = Array.from(event.target.files);
        if (!files.length) return alert("V√¶lg mindst √©t billede.");

        files.sort((a, b) => a.name.localeCompare(b.name));
        images = files.map(f => URL.createObjectURL(f));

        frame = 0;
        updateImage();
        viewer.style.display = "block";

        // Canvas-st√∏rrelse
        canvas.width = viewer.clientWidth;
        canvas.height = viewer.clientHeight;
        drawCircles();
    });

    // --- Rotation med mus ---
    viewer.addEventListener("mousedown", e => {
        isDragging = true;
        startX = e.clientX;
        viewer.style.cursor = "grabbing";
    });

    viewer.addEventListener("mouseup", () => {
        isDragging = false;
        viewer.style.cursor = "grab";
    });

    viewer.addEventListener("mousemove", e => {
        if (!isDragging || !images.length) return;
        const delta = e.clientX - startX;
        if (Math.abs(delta) > 10) {
            frame += delta > 0 ? -1 : 1;
            if (frame < 0) frame = images.length - 1;
            if (frame >= images.length) frame = 0;
            updateImage();
            startX = e.clientX;
        }
    });

    // --- Zoom med scroll ---
    viewer.addEventListener("wheel", e => {
        e.preventDefault();
        zoom += e.deltaY < 0 ? 0.1 : -0.1;
        zoom = Math.min(Math.max(zoom, 1), 3);
        car.style.transform = canvas.style.transform = `scale(${zoom})`;
    });

    // --- Dobbeltklik nulstiller zoom ---
    viewer.addEventListener("dblclick", () => {
        zoom = 1;
        car.style.transform = canvas.style.transform = "scale(1)";
    });

    // --- Touchrotation og pinchzoom ---
    let lastTouchX = 0;

    viewer.addEventListener("touchstart", e => {
        if (e.touches.length === 1) lastTouchX = e.touches[0].clientX;
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            initialDistance = Math.hypot(dx, dy);
        }
        e.preventDefault();
    });

    viewer.addEventListener("touchmove", e => {
        if (e.touches.length === 1) {
            const touchX = e.touches[0].clientX;
            const delta = touchX - lastTouchX;
            if (Math.abs(delta) > 10 && images.length) {
                frame += delta > 0 ? -1 : 1;
                if (frame < 0) frame = images.length - 1;
                if (frame >= images.length) frame = 0;
                updateImage();
                lastTouchX = touchX;
            }
            e.preventDefault();
        }
        // --- Pinch zoom ---
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const distance = Math.hypot(dx, dy);
            const scaleChange = distance / initialDistance;
            zoom *= scaleChange;
            zoom = Math.min(Math.max(zoom, 1), 3);
            car.style.transform = canvas.style.transform = `scale(${zoom})`;
            initialDistance = distance;
            e.preventDefault();
        }
    });

    // --- Touch events: tilf√∏j/flyt/slet cirkler ---
    canvas.addEventListener("touchstart", e => {
        e.preventDefault();
        if (e.touches.length === 1) {
            const pos = getTouchPos(e);
            dragIndex = circles.findIndex(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);
            dragStart = pos;

            if (dragIndex === -1) {
                circles.push({ x: pos.x, y: pos.y, radius: 30, color: "red" });
                drawCircles();
            } else {
                const now = Date.now();
                if (now - lastTouchTime < 400) {
                    circles.splice(dragIndex, 1);
                    dragIndex = null;
                    drawCircles();
                }
                lastTouchTime = now;
            }
        }
    });

    canvas.addEventListener("touchmove", e => {
        e.preventDefault();
        if (e.touches.length === 1 && dragIndex !== null) {
            const pos = getTouchPos(e);
            circles[dragIndex].x += pos.x - dragStart.x;
            circles[dragIndex].y += pos.y - dragStart.y;
            dragStart = pos;
            drawCircles();
        }
    });

    canvas.addEventListener("touchend", () => {
        dragIndex = null;
    });

    // --- Start/Stop animation ---
    let interval = null;

    document.getElementById("startBtn").addEventListener("click", () => {
        if (!images.length) {
            alert("V√¶lg billeder f√∏rst!");
            return;
        }
        if (interval) return; // allerede i gang

        interval = setInterval(() => {
            frame = (frame + 1) % images.length;
            updateImage();
        }, 300); // Skift billede hver 150 ms (ca. 6 fps)
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
        clearInterval(interval);
        interval = null;
    });

    // --- Smart tilbageknap ---
    document.getElementById("backBtn").addEventListener("click", () => {
        if (window.AndroidInterface) {
            window.AndroidInterface.goBackToDashboard();
        } else {
            window.location.href = "dashboard.html";
        }
    });
</script>

</body>
</html>