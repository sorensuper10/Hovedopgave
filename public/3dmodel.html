<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360Â° Bilvisning â€“ Upload</title>
    <style>
        html, body {
            overscroll-behavior: none;
            touch-action: none;
            background: #f2f2f2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #upload-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #viewer {
            width: 600px;
            height: 400px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: grab;
            background: #fff;
            display: none;
            position: relative;
        }

        #viewer img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* standard pÃ¥ web */
            user-select: none;
            pointer-events: none;
            transform-origin: center center;
            transition: transform 0.15s ease-out;
        }

        /* ğŸ“± Mobil */
        @media (max-width: 768px) {
            #viewer {
                width: 90vw;
                max-width: 600px;
                aspect-ratio: 3 / 2;
            }

            #viewer img {
                object-fit: contain; /* sÃ¥ hele bilen ses pÃ¥ mobil */
            }

            /* ğŸ’¡ Knaplayout kun pÃ¥ mobil */
            #control-buttons {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                width: 90vw;
            }

            button {
                flex: 1 1 45%;
                min-width: 120px;
                font-size: 14px;
                padding: 10px;
            }
            #backBtn {
                width: auto;
                font-size: 14px;
                padding: 8px 16px;
                margin-top: 15px;
                align-self: center;
                flex: none;
            }
        }

        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }

        button {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #1976d2;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background: #0d47a1;
        }

        #control-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

    </style>
</head>
<body>

<div id="upload-container">
    <h2>Upload billeder til 360Â° visning</h2>
    <input type="file" id="imageInput" accept="image/*" multiple>
    <p>VÃ¦lg fx 10â€“20 billeder taget rundt om bilen.</p>
</div>

<div id="viewer">
    <img id="car" />
    <canvas id="canvasOverlay"></canvas>
</div>

<div id="control-buttons">
    <button id="startAnimBtn">â–¶ï¸ Start animation</button>
    <button id="stopAnimBtn" disabled>â¸ï¸ Stop animation</button>
    <button id="toggleMarksBtn">âœï¸ Markering: Fra</button>
    <button id="saveImageBtn">ğŸ’¾ Gem billede</button>
    <button id="cameraBtn" style="display:none;">ğŸ“· Tag billede</button>
</div>

<button id="backBtn">ğŸ”™ Tilbage til Dashboard</button>

<script>
    // --- Generelle variabler ---
    let images = [];
    let frame = 0;
    let zoom = 1;
    let interval = null;
    let initialDistance = 0;
    let isDragging = false;
    let startX = 0;

    const viewer = document.getElementById("viewer");
    const car = document.getElementById("car");
    const canvas = document.getElementById("canvasOverlay");
    const ctx = canvas.getContext("2d");

    // --- Markeringer (gemmes per billede/frame) ---
    let markingEnabled = false;
    let marks = {}; // fx marks[0] = [ {x,y,radius,color}, ... ]
    let lastTouchTime = 0;

    // --- HjÃ¦lpefunktioner ---
    function getTouchPos(e) {
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        return { x: t.clientX - rect.left, y: t.clientY - rect.top };
    }

    function drawCircles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const frameCircles = marks[frame] || [];
        frameCircles.forEach(c => {
            ctx.beginPath();
            ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
            ctx.strokeStyle = c.color;
            ctx.lineWidth = 3;
            ctx.stroke();
        });
    }

    function updateImage() {
        car.src = images[frame];
        drawCircles(); // Tegn markeringer for aktuel frame
    }

    // --- Rotation (mus) ---
    viewer.addEventListener("mousedown", e => {
        if (markingEnabled) return; // ğŸš« ingen rotation ved markering
        isDragging = true;
        startX = e.clientX;
        viewer.style.cursor = "grabbing";
    });

    viewer.addEventListener("mouseup", () => {
        isDragging = false;
        viewer.style.cursor = "grab";
    });

    viewer.addEventListener("mousemove", e => {
        if (markingEnabled) return; // ğŸš« ingen rotation ved markering
        if (!isDragging || !images.length) return;
        const delta = e.clientX - startX;
        if (Math.abs(delta) > 10) {
            frame += delta > 0 ? -1 : 1;
            if (frame < 0) frame = images.length - 1;
            if (frame >= images.length) frame = 0;
            updateImage();
            startX = e.clientX;
        }
    });

    // --- Zoom ---
    viewer.addEventListener("wheel", e => {
        e.preventDefault();
        zoom += e.deltaY < 0 ? 0.1 : -0.1;
        zoom = Math.min(Math.max(zoom, 1), 3);
        car.style.transform = canvas.style.transform = `scale(${zoom})`;
    });

    viewer.addEventListener("dblclick", () => {
        zoom = 1;
        car.style.transform = canvas.style.transform = "scale(1)";
    });

    // --- Touchrotation + pinchzoom ---
    let lastTouchX = 0;

    viewer.addEventListener("touchstart", e => {
        if (e.touches.length === 1) lastTouchX = e.touches[0].clientX;
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            initialDistance = Math.hypot(dx, dy);
        }
        e.preventDefault();
    });

    viewer.addEventListener("touchmove", e => {
        if (e.touches.length === 1 && !markingEnabled) {
            const touchX = e.touches[0].clientX;
            const delta = touchX - lastTouchX;
            if (Math.abs(delta) > 10 && images.length) {
                frame += delta > 0 ? -1 : 1;
                if (frame < 0) frame = images.length - 1;
                if (frame >= images.length) frame = 0;
                updateImage();
                lastTouchX = touchX;
            }
            e.preventDefault();
        }
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const distance = Math.hypot(dx, dy);
            const scaleChange = distance / initialDistance;
            zoom *= scaleChange;
            zoom = Math.min(Math.max(zoom, 1), 3);
            car.style.transform = canvas.style.transform = `scale(${zoom})`;
            initialDistance = distance;
            e.preventDefault();
        }
    });

    // --- Markeringer med mus pÃ¥ web ---
    let isMouseDown = false;
    let selectedCircle = null;

    canvas.addEventListener("mousedown", e => {
        if (!markingEnabled) return;
        const rect = canvas.getBoundingClientRect();
        const pos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        if (!marks[frame]) marks[frame] = [];
        const frameCircles = marks[frame];

        // Find eksisterende cirkel under musen
        selectedCircle = frameCircles.find(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);

        const now = Date.now();
        if (!selectedCircle) {
            // Opret ny cirkel
            frameCircles.push({ x: pos.x, y: pos.y, radius: 30, color: "red" });
            drawCircles();
        } else if (now - lastTouchTime < 400) {
            // Dobbeltklik sletter
            const i = frameCircles.indexOf(selectedCircle);
            frameCircles.splice(i, 1);
            drawCircles();
        }
        lastTouchTime = now;
        isMouseDown = true;
    });

    canvas.addEventListener("mousemove", e => {
        if (!markingEnabled || !isMouseDown || !selectedCircle) return;
        const rect = canvas.getBoundingClientRect();
        const pos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        selectedCircle.x = pos.x;
        selectedCircle.y = pos.y;
        drawCircles();
    });

    canvas.addEventListener("mouseup", () => {
        isMouseDown = false;
        selectedCircle = null;
    });

    // --- Markeringer (touch) ---
    canvas.addEventListener("touchstart", e => {
        if (!markingEnabled) return;
        e.preventDefault();
        const pos = getTouchPos(e);

        if (!marks[frame]) marks[frame] = [];
        const frameCircles = marks[frame];
        let dragIndex = frameCircles.findIndex(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);
        const now = Date.now();

        if (dragIndex === -1) {
            frameCircles.push({ x: pos.x, y: pos.y, radius: 30, color: "red" });
        } else if (now - lastTouchTime < 400) {
            frameCircles.splice(dragIndex, 1); // dobbelttryk = slet
        }
        lastTouchTime = now;
        drawCircles();
    });

    canvas.addEventListener("touchmove", e => {
        if (!markingEnabled) return;
        e.preventDefault();
        const frameCircles = marks[frame];
        if (!frameCircles) return;

        const pos = getTouchPos(e);
        const dragIndex = frameCircles.findIndex(c => Math.hypot(c.x - pos.x, c.y - pos.y) < c.radius);
        if (dragIndex !== -1) {
            frameCircles[dragIndex].x = pos.x;
            frameCircles[dragIndex].y = pos.y;
            drawCircles();
        }
    });

    // --- Animation ---
    const startBtn = document.getElementById("startAnimBtn");
    const stopBtn = document.getElementById("stopAnimBtn");

    startBtn.addEventListener("click", () => {
        if (!images.length) return;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        interval = setInterval(() => {
            frame = (frame + 1) % images.length;
            updateImage();
        }, 300); // 300ms = rolig rotation
    });

    stopBtn.addEventListener("click", () => {
        clearInterval(interval);
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });

    // --- Toggle markering ---
    const toggleBtn = document.getElementById("toggleMarksBtn");
    toggleBtn.addEventListener("click", () => {
        markingEnabled = !markingEnabled;
        toggleBtn.textContent = markingEnabled ? "âœï¸ Markering: Til" : "âœï¸ Markering: Fra";
    });

    // --- Tilbage ---
    document.getElementById("backBtn").addEventListener("click", () => {
        if (window.AndroidInterface) {
            window.AndroidInterface.goBackToDashboard();
        } else {
            window.location.href = "dashboard.html";
        }
    });

    document.getElementById("cameraBtn").addEventListener("click", () => {
        if (window.AndroidInterface && typeof window.AndroidInterface.openCamera === "function") {
            window.AndroidInterface.openCamera(); // ğŸ“¸ kald Android-metoden
        } else {
            alert("Kamera-funktion er kun tilgÃ¦ngelig i Android-appen.");
        }
    });

    // --- Gem billede med markeringer ---
    document.getElementById("saveImageBtn").addEventListener("click", async () => {
        if (!images.length) return alert("VÃ¦lg mindst Ã©t billede fÃ¸rst!");

        try {
            const currentImage = images[frame];
            const frameMarks = marks[frame] || [];
            console.log("Gemmer billede:", currentImage, "med", frameMarks.length, "markeringer");

            // 1ï¸âƒ£ IndlÃ¦s billedet i et canvas
            const img = new Image();
            img.src = currentImage;
            await img.decode();

            const tempCanvas = document.createElement("canvas");
            const tempCtx = tempCanvas.getContext("2d");
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;

            // 2ï¸âƒ£ Tegn originalbilledet
            tempCtx.drawImage(img, 0, 0, img.width, img.height);

            // 3ï¸âƒ£ Tegn markeringerne ovenpÃ¥
            frameMarks.forEach(m => {
                tempCtx.beginPath();
                tempCtx.arc(
                    m.x * (img.width / canvas.width),
                    m.y * (img.height / canvas.height),
                    m.radius * (img.width / canvas.width),
                    0,
                    Math.PI * 2
                );
                tempCtx.strokeStyle = m.color || "red";
                tempCtx.lineWidth = 4;
                tempCtx.stroke();
            });

            // 4ï¸âƒ£ Konverter det fÃ¦rdige billede til base64 (JPEG)
            const finalDataURL = tempCanvas.toDataURL("image/jpeg", 0.9);

            // 5ï¸âƒ£ Gem forskelligt afhÃ¦ngig af miljÃ¸
            if (window.AndroidInterface && typeof window.AndroidInterface.saveImageBase64 === "function") {
                // ğŸ“± Android-app (WebView)
                window.AndroidInterface.saveImageBase64(finalDataURL);
                alert("âœ… Billedet er gemt lokalt pÃ¥ telefonen!");
            } else {
                // ğŸŒ Webbrowser
                const a = document.createElement("a");
                a.href = finalDataURL;
                a.download = "bilbillede_" + Date.now() + ".jpg";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert("ğŸ’¾ Billedet blev downloadet via browseren!");
            }

            // 6ï¸âƒ£ Upload til backend
            const payload = {
                filename: "bilbillede_" + Date.now() + ".jpg",
                data: finalDataURL // ğŸ‘ˆ fÃ¦rdigt billede med markeringer
            };

            const BASE_URL = window.location.hostname === "localhost"
                ? "http://localhost:3000"
                : "https://hovedopgave.onrender.com";

            const response = await fetch(`${BASE_URL}/uploadImage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.success) {
                alert("âœ… Billedet med markeringer er gemt bÃ¥de lokalt og i MongoDB!");
            } else {
                alert("âš ï¸ Kun gemt lokalt (fejl ved upload til MongoDB).");
            }
        } catch (err) {
            console.error("Fejl ved gemning:", err);
            alert("Der opstod en fejl under gemning.");
        }
    });

    // ğŸ“± Kun vis kamera-knappen, hvis vi er i Android WebView
    if (window.AndroidInterface) {
        document.getElementById("cameraBtn").style.display = "inline-block";
    }

    document.getElementById("imageInput").addEventListener("change", e => {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        // SortÃ©r og lav nye URLs
        files.sort((a, b) => a.name.localeCompare(b.name));
        const newImages = files.map(f => URL.createObjectURL(f));

        // TilfÃ¸j i stedet for at overskrive
        images.push(...newImages);

        // ğŸ“¸ Hvis der ikke var billeder fÃ¸r, vis fÃ¸rste
        if (images.length === newImages.length) {
            frame = 0;
            car.src = images[0];
            viewer.style.display = "block";
            canvas.width = viewer.clientWidth;
            canvas.height = viewer.clientHeight;
            drawCircles();
        } else {
            // ğŸ”„ Ellers opdater visningen til det sidst tilfÃ¸jede
            frame = images.length - 1;
            updateImage();
        }

        alert("ğŸ“ " + newImages.length + " nye billede(r) tilfÃ¸jet!");
    });

    // ğŸ“¸ Modtag nyt billede fra Android (kamera)
    window.addCapturedImage = function (uri) {
        if (!uri) return;

        // ğŸ”¹ Brug altid det samme array (uanset rÃ¦kkefÃ¸lge)
        if (!images) images = [];
        images.push(uri);

        // ğŸ”¹ SÃ¸rg for, at markeringer findes for det nye billede
        const newFrameIndex = images.length - 1;
        marks[newFrameIndex] = [];

        // ğŸ”¹ Vis det nye billede
        const img = new Image();
        img.onload = function () {
            frame = newFrameIndex;
            car.src = uri;
            viewer.style.display = "block";
            canvas.width = viewer.clientWidth;
            canvas.height = viewer.clientHeight;
            drawCircles();

            alert("ğŸ“· Nyt billede tilfÃ¸jet fra kamera!");
        };
        img.src = uri;
    };
</script>
</body>
</html>